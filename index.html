<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOP Kwitansi Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container py-5">
    <h1 class="mb-4 text-center fw-bold">DOP Kwitansi Generator</h1>
    
    <form id="dopForm">
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">Informasi Perjalanan Dinas</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Sub Unit Organisasi</label>
                        <input type="text" class="form-control" name="sub_unit.nama" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Kode Sub Unit</label>
                        <input type="text" class="form-control" name="sub_unit.kode" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tujuan Perjalanan</label>
                        <input type="text" class="form-control" name="perjalanan.nama" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tempat</label>
                        <input type="text" class="form-control" name="perjalanan.tempat" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tanggal Mulai</label>
                        <input type="date" class="form-control" name="perjalanan.tgl_mulai" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tanggal Selesai</label>
                        <input type="date" class="form-control" name="perjalanan.tgl_selesai" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Program</label>
                        <input type="text" class="form-control" name="program" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Kode Rekening</label>
                        <input type="text" class="form-control" name="kode_rekening" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-dark text-white">Pegawai</div>
            <div class="card-body" id="pegawaiSection">
                <!-- Pegawai input akan disini -->
            </div>
            <div class="card-footer text-end">
                <button type="button" class="btn btn-outline-primary" id="addPegawaiBtn">Tambah Pegawai</button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-dark text-white">Validasi & Kwitansi</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nama PPTK</label>
                        <input type="text" class="form-control" name="validasi.pptk.nama" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">NIP PPTK</label>
                        <input type="text" class="form-control" name="validasi.pptk.nip" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nama Bendahara</label>
                        <input type="text" class="form-control" name="validasi.bd.nama" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">NIP Bendahara</label>
                        <input type="text" class="form-control" name="validasi.bd.nip" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Jabatan Bendahara</label>
                        <input type="text" class="form-control" name="validasi.bd.jabatan" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tanggal Kwitansi</label>
                        <input type="date" class="form-control" name="validasi.tanggal" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mb-5">
            <button type="button" class="btn btn-secondary me-3" id="previewBtn">Preview JSON</button>
            <button type="submit" class="btn btn-primary">Generate DOCX</button>
        </div>
    </form>

    <pre id="previewJson" class="bg-light p-3 rounded d-none"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.32.3/build/docxtemplater.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
// script.js

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function toTerbilang(nilai) {
    const angka = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan"];
    const satuan = ["", "Ribu", "Juta", "Miliar", "Triliun"];

    if (nilai === 0) return "Nol Rupiah";

    let strNilai = nilai.toString();
    let result = "";
    let posisi = 0;

    while (strNilai.length > 0) {
        let tigaAngka = parseInt(strNilai.slice(-3));
        strNilai = strNilai.slice(0, -3);

        if (tigaAngka) {
            let ratusan = Math.floor(tigaAngka / 100);
            let puluhan = Math.floor((tigaAngka % 100) / 10);
            let satuanAngka = tigaAngka % 10;

            let segment = "";
            if (ratusan) segment += angka[ratusan] + " Ratus ";
            if (puluhan > 1) {
                segment += angka[puluhan] + " Puluh ";
                if (satuanAngka) segment += angka[satuanAngka] + " ";
            } else if (puluhan === 1) {
                if (satuanAngka === 0) segment += "Sepuluh ";
                else if (satuanAngka === 1) segment += "Sebelas ";
                else segment += angka[satuanAngka] + " Belas ";
            } else if (satuanAngka) segment += angka[satuanAngka] + " ";

            result = segment + satuan[posisi] + " " + result;
        }
        posisi++;
    }
    return result.trim() + " Rupiah";
}

function addPegawai(index = 0) {
    const pegawaiDiv = document.createElement('div');
    pegawaiDiv.className = 'border rounded p-3 mb-3 pegawai-item';
    pegawaiDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Pegawai ${index + 1}</h5>
            ${index > 0 ? '<button type="button" class="btn btn-sm btn-danger remove-pegawai">Hapus</button>' : ''}
        </div>
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Nama</label>
                <input type="text" class="form-control" name="billing[${index}].pegawai.nama" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">NIP</label>
                <input type="text" class="form-control" name="billing[${index}].pegawai.nip" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Uang Harian (Rp)</label>
                <input type="text" class="form-control format-number" name="billing[${index}].harian_nom">
            </div>
            <div class="col-md-6">
                <label class="form-label">Volume Hari</label>
                <input type="number" class="form-control" name="billing[${index}].harian_vol">
            </div>
            ${index === 0 ? `
            <div class="col-md-6">
                <label class="form-label">Uang Transport (Rp)</label>
                <input type="text" class="form-control format-number" name="billing.transport.nom">
            </div>
            <div class="col-md-6">
                <label class="form-label">Volume Transport</label>
                <input type="number" class="form-control" name="billing.transport.vol">
            </div>
            ` : ``}
        </div>
    `;
    document.getElementById('pegawaiSection').appendChild(pegawaiDiv);
}

function removePegawai(e) {
    if (e.target.classList.contains('remove-pegawai')) {
        e.target.closest('.pegawai-item').remove();
    }
}

document.getElementById('pegawaiSection').addEventListener('click', removePegawai);

let pegawaiCounter = 0;
addPegawai(pegawaiCounter++);

document.getElementById('addPegawaiBtn').addEventListener('click', function() {
    addPegawai(pegawaiCounter++);
});

// Preview JSON
function formToJSON(form) {
    const formData = new FormData(form);
    const obj = {};
    for (let [key, value] of formData.entries()) {
        const keys = key.replace(/\]/g, '').split(/\[|\./);
        let current = obj;
        keys.forEach((k, i) => {
            if (i === keys.length - 1) {
                current[k] = value;
            } else {
                current[k] = current[k] || {};
                current = current[k];
            }
        });
    }
    return obj;
}

document.getElementById('previewBtn').addEventListener('click', function() {
    const data = formToJSON(document.getElementById('dopForm'));
    document.getElementById('previewJson').textContent = JSON.stringify(data, null, 2);
    document.getElementById('previewJson').classList.remove('d-none');
});
</script>
</body>
</html>